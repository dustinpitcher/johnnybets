# JohnnyBets Project Context

## Architecture

- **Frontend**: Next.js 15 (App Router) on Azure Container App (`ca-jbet-web-prod-eus2`)
- **Backend**: FastAPI + LangGraph on Azure Container App (`ca-jbet-api-prod-eus2`)
- **Database**: Azure PostgreSQL Flexible Server (`psql-jbet-prod-eus2`)
- **DNS/CDN**: Cloudflare (WAF, rate limiting, caching)
- **CI/CD**: GitHub Actions → Azure Container Registry → Container Apps

## Live URLs

**Production:**
- https://johnnybets.ai (frontend)
- https://api.johnnybets.ai (API)

**Staging:**
- https://ca-jbet-web-stg-eus2.blueplant-0e5d4fc7.eastus2.azurecontainerapps.io (frontend)
- https://ca-jbet-api-stg-eus2.blueplant-0e5d4fc7.eastus2.azurecontainerapps.io (API)

## Critical Deployment Rules

### NEVER use `azure/container-apps-deploy-action` with `environmentVariables`
It **REPLACES ALL env vars**, breaking production. Use `az containerapp update --image` instead:

```yaml
# CORRECT - only updates image, preserves env vars
az containerapp update \
  --name ${{ env.CONTAINER_APP_NAME }} \
  --resource-group ${{ env.RESOURCE_GROUP }} \
  --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
```

### `NEXT_PUBLIC_*` variables are baked at BUILD time
Must be set during Docker build, not runtime:
```dockerfile
ARG NEXT_PUBLIC_API_URL=https://api.johnnybets.ai
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
RUN npm run build
```

### `.env.local` overrides `.env.production`
The `web/.dockerignore` excludes `.env.local` to prevent local config from breaking prod builds.

## Environment Variables

Secrets are stored in Container App secrets and referenced via `secretref:`:
- `OPENROUTER_API_KEY` - LLM API access
- `ODDS_API_KEY` / `THE_ODDS_API_KEY` - Sports odds data
- `DATABASE_URL` - PostgreSQL connection string

To restore env vars if accidentally wiped:
```bash
az containerapp update \
  --name ca-jbet-api-prod-eus2 \
  --resource-group rg-johnnybets-prod-eus2 \
  --set-env-vars \
    "OPENROUTER_API_KEY=secretref:openrouter-api-key" \
    "ODDS_API_KEY=secretref:odds-api-key" \
    "THE_ODDS_API_KEY=secretref:odds-api-key" \
    "DATABASE_URL=secretref:database-url" \
    "BETTING_AGENT_MODEL=x-ai/grok-4.1-fast"
```

## Naming Convention

Pattern: `{prefix}-{app}-{service}-{env}-{region}`

| Resource | Production | Staging |
|----------|------------|---------|
| Resource Group | `rg-johnnybets-prod-eus2` | (shared) |
| Container Registry | `crjohnnybets` | (shared) |
| API Container App | `ca-jbet-api-prod-eus2` | `ca-jbet-api-stg-eus2` |
| Web Container App | `ca-jbet-web-prod-eus2` | `ca-jbet-web-stg-eus2` |
| PostgreSQL | `psql-jbet-prod-eus2` | (shared, `staging` schema) |
| Key Vault | `kv-jbet-prod-eus2` | (shared) |

## Staging Environment

Staging mirrors production but uses a separate PostgreSQL schema for data isolation.

### Deploy to Staging

Manual trigger only via GitHub Actions:
1. Go to **Actions** → **Deploy Web to Staging** or **Deploy API to Staging**
2. Click **Run workflow**
3. Optionally specify a branch/commit (defaults to `main`)

### Staging Database

Staging uses the same PostgreSQL server but a separate `staging` schema:
- Production: `public` schema (default)
- Staging: `staging` schema (via `?schema=staging` in connection URL)

### Staging Container Apps

Both staging apps have `min-replicas=0` to save costs when not in use. They may have cold start delays on first request.

```bash
# Check staging web logs
az containerapp logs show --name ca-jbet-web-stg-eus2 --resource-group rg-johnnybets-prod-eus2 --tail 50

# Check staging API logs
az containerapp logs show --name ca-jbet-api-stg-eus2 --resource-group rg-johnnybets-prod-eus2 --tail 50

# Force restart staging
az containerapp revision restart --name ca-jbet-web-stg-eus2 --resource-group rg-johnnybets-prod-eus2
```

## Common Issues

| Issue | Cause | Fix |
|-------|-------|-----|
| `401 - No cookie auth credentials` | Missing OPENROUTER_API_KEY | Restore env vars |
| Ticker shows "Unable to load scores" | NEXT_PUBLIC_API_URL not set at build | Check .dockerignore, rebuild |
| Container crash loop | Import error (check logs) | Add missing dep to requirements.txt |
| Cold start timeouts | minReplicas=0 | Set `--min-replicas 1` |

## NFL Data Notes

- Team names must be normalized to abbreviations (NE, SEA, BUF) - see `normalize_team()` in `src/tools/nfl_data.py`
- PBP data is cached via `_pbp_combined_cache` to avoid loading 40+ times per request

## Useful Commands

```bash
# Check API health
curl https://api.johnnybets.ai/health

# View container logs
az containerapp logs show --name ca-jbet-api-prod-eus2 --resource-group rg-johnnybets-prod-eus2 --tail 50

# Check container status
az containerapp replica list --name ca-jbet-api-prod-eus2 --resource-group rg-johnnybets-prod-eus2 -o table

# Local development
python -m uvicorn api.main:app --port 8000 --reload
cd web && npm run dev
```

## Python Dependencies

If a module imports a package, it MUST be in `requirements.txt` (not just `requirements-dev.txt`). Common culprits: `rich`, `typer`.

## Docker

Always use `--platform linux/amd64` for Azure Container Apps.
